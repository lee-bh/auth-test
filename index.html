<html>
    <head>
        <title>My Diary</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 0;
            }
            #signInButton {
                display: block;
            }
            #signOutButton {
                display: none;
            }
            #writeForm {
                display: none;
            }
        </style>
    </head>
    <body>
        <header></header>
            <h1>My Diary</h1>
            <button id="signInButton">Sign In</button>
            <button id="signOutButton">Sign Out</button>
        </header>
        <main id="diary-entry-container">

        </main>
        <section id="writeForm">
            <input type="text" id="diaryTitle" placeholder="Title">
            <textarea id="diaryEntry" placeholder="Write your diary here..."></textarea>
            <button id="saveButton">Save</button>
        </section>
        <section id="editForm">
           
        </section>
        <footer>
            <p>Copyright 2025 My Diary</p>
        </footer>
        <script type="module">
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
            import { getFirestore, collection, getDocs, addDoc, query, orderBy, deleteDoc, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
            import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
        
            // TODO: Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries
          
            // Your web app's Firebase configuration
            const firebaseConfig = {
              apiKey: "AIzaSyBE8Mt6sAgO30wUXmuaNfFP0YEuLCs3rJE",
              authDomain: "auth-test-b35cf.firebaseapp.com",
              projectId: "auth-test-b35cf",
              storageBucket: "auth-test-b35cf.firebasestorage.app",
              messagingSenderId: "798896697380",
              appId: "1:798896697380:web:0a207a3eb11c6be93be8b1"
            };
          
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            const provider = new GoogleAuthProvider();
            const writeForm = document.getElementById("writeForm");
            const signInButton = document.getElementById("signInButton");
            const signOutButton = document.getElementById("signOutButton");
          
            // check if user is logged in
            auth.onAuthStateChanged(user => {
                if (user) {
                    writeForm.style.display = "block";
                    signInButton.style.display = "none";
                    signOutButton.style.display = "block";
                } else {
                    writeForm.style.display = "none";
                    signInButton.style.display = "block";
                    signOutButton.style.display = "none";
                }
            });

            function sIn() {
                signInWithPopup(auth, provider);
                getEntries();
            }

            function sOut() {
                signOut(auth);
                document.getElementById("diary-entry-container").innerHTML = "";
            }

            signInButton.addEventListener("click", sIn);
            signOutButton.addEventListener("click", sOut);


            const saveButton = document.getElementById("saveButton");
            saveButton.addEventListener("click", saveEntry);

            function saveEntry() {
                
                const title = document.getElementById("diaryTitle").value;
                const entry = document.getElementById("diaryEntry").value;
                const user = auth.currentUser;
                if (!user) {
                    console.error("User not logged in");
                    return;
                }
                const entriesCollection = collection(db, "diary-entries");
                const newEntry = {
                    title: title,
                    entry: entry,
                    userId: user.uid,
                    createdAt: new Date()
                }
                addDoc(entriesCollection, newEntry).then((docRef) => {
                    console.log("Document written with ID: ", docRef.id);
                    getEntries();
                }).catch((error) => {
                    console.error("Error adding document: ", error);
                });
            }

            getEntries();
            async function getEntries() {
                const entriesCollection = collection(db, "diary-entries");
                const entriesQuery = query(entriesCollection, orderBy("createdAt", "desc"));
                const entriesSnapshot = await getDocs(entriesQuery);
                const entries = entriesSnapshot.docs.map(doc => doc.data());
                const user = auth.currentUser;
                if (!user) {
                    console.error("User not logged in");
                    return;
                }
                entries.forEach(entry => {
                    const entrySection = document.createElement("section");
                    entrySection.classList.add("diary-entry");
                    entrySection.innerHTML = `
                        <h2>${entry.title}</h2>
                        <p>${entry.createdAt.toDate().toLocaleDateString()}</p>
                        <p>${entry.entry}</p>
                    `;
                    if (user.uid === entry.userId) {
                        const deleteButton = document.createElement("button");
                        deleteButton.id = "deleteButton";
                        deleteButton.textContent = "Delete";
                        entrySection.appendChild(deleteButton);
                        deleteButton.addEventListener("click", () => deleteEntry(entry.id));

                        const editButton = document.createElement("button");
                        editButton.id = "editButton";
                        editButton.textContent = "Edit";
                        entrySection.appendChild(editButton);
                        editButton.addEventListener("click", () => editEntry(entry.id));
                    }
                    document.getElementById("diary-entry-container").appendChild(entrySection);
                    });
            }   

            
            async function deleteEntry(entryId) {
                const entriesCollection = collection(db, "diary-entries");
                const entryDoc = doc(entriesCollection, entryId);
                deleteDoc(entryDoc);
                getEntries();
            }

            async function editEntry(entryId) {
                const entriesCollection = collection(db, "diary-entries");
                const entryDoc = doc(entriesCollection, entryId);
                const entry = await getDoc(entryDoc);
                const entryData = entry.data();
                const editForm = document.getElementById("editForm");
                editForm.style.display = "block";
                editForm.innerHTML = `
                    <input type="text" id="editTitle" value="${entryData.title}">
                    <textarea id="editEntry">${entryData.entry}</textarea>
                    <button id="saveEditButton">Save</button>
                `;
                const saveEditButton = document.getElementById("saveEditButton");
                saveEditButton.addEventListener("click", () => saveEditedEntry(entryId));
            }

            async function saveEditedEntry(entryId) {
                const entriesCollection = collection(db, "diary-entries");  
                const entryDoc = doc(entriesCollection, entryId);
                const title = document.getElementById("editTitle").value;
                const entry = document.getElementById("editEntry").value;
                const user = auth.currentUser;
                if (!user) {
                    console.error("User not logged in");
                    return;
                }
                const newEntry = {
                    title: title,
                    entry: entry,
                    userId: user.uid,
                    createdAt: new Date()
                }
                updateDoc(entryDoc, newEntry);
                getEntries();
                editForm.style.display = "none";
            }
          </script>
    </body>